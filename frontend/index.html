<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maruti Pharmaceuticals - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for Gauges -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
        }

        /* Header */
        #head {
            background-color: #2e7d32; /* Dark Green */
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #head-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* Using a placeholder for the logo image */
        #head-left img {
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        #head h1 {
            color: #fff;
            font-size: 24px;
            margin: 0;
            font-weight: 700;
        }

        /* Navigation Bar */
        .navbar {
            background-color: #fff;
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .navbar ul {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar li {
            margin: 0 15px;
        }
        .navbar a {
            text-decoration: none;
            color: #155724; /* Darker Green */
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .navbar a:hover {
            color: #0c3315;
            background-color: #f0fff0;
        }

        /* Slider/Hero */
        .slider {
            margin: 20px auto;
            width: min(1100px, 94%);
            height: 250px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #a8df8e 0%, #2e7d32 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .slider h2 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
            margin: 0;
            padding: 0 20px;
        }

        .dashboard {
            width: min(1100px, 94%);
            margin: 20px auto;
        }
        .dashboard h2 {
            text-align: center;
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 24px;
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        .summary-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .summary-card p {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        .gauge-container {
            width: 100%;
            max-width: 140px;
            margin: 0 auto 10px;
        }

        footer {
            text-align: center;
            padding: 15px;
            background-color: #f0f0f0;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            #head {
                padding: 15px 20px;
            }
            .slider {
                height: 180px;
                font-size: 24px;
                width: 95%;
            }
            .dashboard {
                width: 95%;
            }
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div id="head">
    <div id="head-left">
        <!-- Placeholder for the logo. Add images/plogo1.png -->
        <img src="https://placehold.co/60x60/a8df8e/2e7d32?text=MP" alt="Maruti Pharmaceuticals Logo">
        <h1>Maruti Pharmaceuticals</h1>
    </div>
</div>

<nav class="navbar">
    <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="add-stock.html">Add Stock</a></li>
        <li><a href="inventory.html">Inventory</a></li>
    </ul>
</nav>

<div class="slider" id="slider">
    <h2 id="sliderText">Seamless Inventory Control, Anytime, Anywhere.</h2>
</div>

<div class="dashboard">
    <h2>Inventory Summary</h2>
    <div class="summary-grid">
        <div class="summary-card">
            <div class="gauge-container">
                <canvas id="g_items"></canvas>
            </div>
            <p><b>Distinct SKUs</b></p>
            <b id="m_items">0</b>
        </div>
        <div class="summary-card">
            <div class="gauge-container">
                <canvas id="g_qty"></canvas>
            </div>
            <p><b>Total Stock Quantity</b></p>
            <b id="m_qty">0</b>
        </div>
        <div class="summary-card">
            <div class="gauge-container">
                <canvas id="g_expired"></canvas>
            </div>
            <p><b>Expired SKUs</b></p>
            <b id="m_expired">0</b>
        </div>
        <div class="summary-card">
            <div class="gauge-container">
                <canvas id="g_near"></canvas>
            </div>
            <p><b>Near Expiry (≤90 days)</b></p>
            <b id="m_near">0</b>
        </div>
    </div>
</div>

<div class="dashboard">
    <h2>Latest Inventory Snapshot</h2>
    <div id="stockContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <p style="grid-column: 1 / -1; text-align: center; color: #666;">Loading inventory...</p>
    </div>
</div>

<footer>
    &copy; 2025 Maruti Pharmaceuticals. All rights reserved.
</footer>

<script>
    // --- IMPORTANT: UPDATE THIS URL WHEN DEPLOYING YOUR BACKEND ---
    const API_BASE = 'http://localhost:3000/api'; 
    const $ = (id) => document.getElementById(id);
    
    const statusFor = (expiry) => {
        const d = Math.floor((new Date(expiry).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)) / 86400000);
        if (d < 0) return { key: 'expired', label: 'Expired' };
        if (d <= 30) return { key: 'soon', label: '≤30d' };
        if (d <= 90) return { key: 'near', label: '≤90d' };
        return { key: 'ok', label: 'OK' };
    };

    // Chart.js Gauge Configuration
    const gaugeCfg = {
        type: 'doughnut', 
        options: { 
            rotation: -90, 
            circumference: 180, 
            cutout: '75%', 
            plugins: { 
                legend: { display: false }, 
                tooltip: { enabled: false } 
            } 
        }
    };

    // Initialize Charts (must be done after Chart.js is loaded)
    let gItems, gQty, gExpired, gNear;
    const initCharts = () => {
        gItems = new Chart($('g_items'), { ...gaugeCfg, data: { datasets: [{ data: [0, 100], backgroundColor: ['#2563eb', '#e5e7eb'], borderWidth: 0 }] } });
        gQty = new Chart($('g_qty'), { ...gaugeCfg, data: { datasets: [{ data: [0, 100], backgroundColor: ['#2e7d32', '#e5e7eb'], borderWidth: 0 }] } });
        gExpired = new Chart($('g_expired'), { ...gaugeCfg, data: { datasets: [{ data: [0, 100], backgroundColor: ['#c62828', '#e5e7eb'], borderWidth: 0 }] } });
        gNear = new Chart($('g_near'), { ...gaugeCfg, data: { datasets: [{ data: [0, 100], backgroundColor: ['#b45309', '#e5e7eb'], borderWidth: 0 }] } });
    }

    const setGauge = (chart, pct, max_val = 100) => {
        const v = Math.min(max_val, Math.max(0, Math.round(pct)));
        chart.data.datasets[0].data = [v, max_val - v];
        chart.update('active');
    };

    const renderDashboard = async () => {
        let items = [];
        try {
            const res = await fetch(`${API_BASE}/inventory`);
            if (!res.ok) throw new Error('Failed to fetch inventory');
            items = await res.json();
        } catch (err) {
            console.error('Error fetching inventory:', err);
            $('stockContainer').innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #c62828;">Error loading inventory: ${err.message}</p>`;
            return;
        }

        let totalQty = 0;
        let expiredSKUCount = 0;
        let nearExpirySKUCount = 0;
        const totalSKUs = items.length;
        const maxQtyVisual = 1000; // Assuming 1000 is a visual max for the quantity gauge

        // Aggregate Data
        items.forEach(it => {
            totalQty += Number(it.quantity || 0);
            const st = statusFor(it['expiry-date']);
            if (st.key === 'expired') {
                expiredSKUCount++;
            } else if (st.key === 'near' || st.key === 'soon') {
                nearExpirySKUCount++;
            }
        });

        // Update Gauges
        setGauge(gItems, totalSKUs, totalSKUs > 5 ? totalSKUs : 5); // Base max on actual SKU count for visual impact
        setGauge(gQty, totalQty, maxQtyVisual);
        setGauge(gExpired, expiredSKUCount, totalSKUs > 5 ? totalSKUs : 5); 
        setGauge(gNear, nearExpirySKUCount, totalSKUs > 5 ? totalSKUs : 5);
        
        // Update Metrics
        $('m_items').textContent = totalSKUs.toLocaleString();
        $('m_qty').textContent = totalQty.toLocaleString();
        $('m_expired').textContent = expiredSKUCount.toLocaleString();
        $('m_near').textContent = nearExpirySKUCount.toLocaleString();

        // Render Stock Snippet (Top 8 items by expiry date)
        const latestItems = items
            .sort((a, b) => new Date(a['expiry-date']) - new Date(b['expiry-date']))
            .slice(0, 8); // Show only the 8 most critical items

        $('stockContainer').innerHTML = latestItems.map(it => {
            const st = statusFor(it['expiry-date']);
            return `
                <div class="summary-card" style="text-align: left; padding: 15px;">
                    <span style="float: right;" class="badge ${st.key}" style="font-size: 10px; opacity: 0.8;">${st.label}</span>
                    <h4 style="margin: 0; color: #2e7d32;">${it.name}</h4>
                    <p style="margin: 0;">${it.strength}</p>
                    <p style="margin: 10px 0 0;">Qty: <b>${it.quantity}</b></p>
                    <p style="margin: 0;">Expiry: <b>${it['expiry-date']}</b></p>
                </div>
            `;
        }).join('');

        if (latestItems.length === 0) {
             $('stockContainer').innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #666;">No stock items found. Add some stock on the 'Add Stock' page!</p>`;
        }
    };

    // Start everything once the window loads
    window.onload = () => {
        initCharts();
        renderDashboard();
    };
</script>
</body>
</html>
